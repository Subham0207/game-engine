1.[DONE] Incorporate JOLT physics engine.
----------
1. Capsule collider update radius and half height to match the character. We need to delete the model geometry from CPU and GPU.
Create a destructor in Model class. Generate new capsule collider model.
-----------
1. [DONE][FOR NOW] Blending Animation -- to have smooth transition b/w two animation.
---Details---
Blendspaces and statemachines.
Have some primitive implementation of a blendspace.
[DONE] fully working blendspaces.
[DONE]Camera behind the character
[DONE] Correct animation to play when turning and moving around. All movement input including diagonal are correctly applying on the physics capsule. Blendspace still broken.
[DONE] Handle playing animation and blendspace separately in Animator class.
[DONE] Next is state machine. Locomotion done, jump state done, dodgeroll state pending.
[DONE] I only have 1 animation of dodge roll:
    1. dodge roll only to mouse direction.
    2. when dodge roll, cancel any directionVector values, and add only towards mouse direction.
[DONE] When jumping, in addition to playing the jump animtion, also make the capsule jump to be able to reach heights, otherwise right now the capsule just collides.
[DONE] jump animation finish is what disables the isjumping bool. So now if the jump animation duration > jump duration then more jumps occur. We need to handle: jump start, isFalling, separately.
not setting startedJump when character is not grounded helped here in input.cs file.
[DONE] Smooth transition b/w poses of two different animation/blendspace.
1. Transition b/w a pose and an animation is working.
2. [DONE]Transition b/w pose and blendspace is not working.
There was a bug related to the execution order of poseTranisition, setting blendselection and m_currentanimation.
3. smooth transition on 2nd time dodgeRoll animation causes jerk and the animation is not played.


[PENDING]Create new Project
when .exe is compiled, the directory links are relative it.[DONE]
Think enginesource code and engine exe.

1. [DONE]Create manifest.json file -- names the project, engine version, and mount points (directories).
2. Project that got created: set it as current project.
3. create a Init UI where we can select a project to open otherwise create a new. No default editor can open otherwise.
4. [DONE] we can save model, Add option in Model class to save physics body if attached. I think for now only type of the body
as string in the model or meta file is sufficient (we don't support this right now so save it in the model binary as string const).
3. [PENDING] Implmement saving/logic to character class as well. this will inturn require the class required in Character to also have saving/loading logic.
Then we move the creationg of blendspace, statmachine, etc to createNewProject. And then in editor add functionality to create these, i.e blendspace etc. , so we can apply them on on character.
[FIXED] saving characer and its attached model only for now. Model filename is bugged leading to overriding the floorBox model file.
This needs a fix. And nothing loads up in the editor for now ( floorBox would have loaded if its modelfile was not overridden ).
Fixed by using guid for meta files And using contentName for file binaries.
[PENDING] Load character and model only for now. 
Only create physics body on model if present. 
No animation logic should be there if there is no animation.
Textures are not loading, due to getting saved in engine assets directory. Should be saved and ref from project directory instead.
I have fixed the directory to  project now for txture files. But the the Materials are loading as NULL. So something wrong with boost serialization of them.
    [DONE]able to load capsule settings and init a new.
    [PENDING]save and load skeleton
    [PENDING]save and load animStatemachine
        [PENDING] cannot serialize a lambda. Will Try Lua scripting with sol2 cpp binding to solve this.
            [DONE] Integrate Lua and sol2
            [PENDING] try it out. Maybe with a test.
            [PENIDNG] create statemachine in createnewproject instead of character constructor. Because we want to save animations to projet dir.
                1. save `.animations` in project directory. corresponding `.meta` files get created.
                2. `.meta` files get scanned and guidToFilePath map is populated.
                3. when loading blendpoint -> load these animations in memory using thier guid. And thus the blendspace will be loaded.
                4. same will happen with state. Either it will load blendspace or an animation using corresponding guids. And thus a statemachine should get loaded.
                5. load statemachine when character is loaded. Observations: The capsule collider is not initialized for the second character.
                [ISSUES]
                    [FIXED]animation not saving
                    [FIXED] `skeleton->skeletaltreeRoot` is coming up null. Called skeletal->buildBoneHerarchy() and initilzing boneshaders to fix.
                    [FIXED] animation didnot load leading to animation being null So animation->GetDuration() call fails. stategraph initialization was wrong in statemachine. Now animations seem to be there.
                    [FIXED] animation not playing on movement inputs.
                    It was due to model shaders being initilized on character so no bone info that got calculated could go through to character's shader.
                    [DONE] Destroy character object after saving creating new project. Because otherwise objects linger in memory and interfere with the loaded project. Like wrong playerController being used to control player since always 0th index one is used.
                    [DONE] Lua script doesnot work.
                    [DONE] Loading multiple character breaks. Now things load. But you cannot select which playerController is active/Possessed.[FIXED] Camera and playerController are managed separately. Telling which playerController to possess doesnot select the correct camera. So I a selecting playerControllerSelectedId + 1 ( since 0th index camera is of editor ).
                    [FIXED] Capsule collider of second character is not there why ?
                        the collider is getting snapped to first character.
                        The location for normal and texture coords are coming empty in the second loaded character collider.
                        I see vertices do have normal and texture but they are still missing in shader.
                        I see in render doc wrong shader is active while drawing this capsule collider.
                        I re-bound shader id for capsule collider on draw. Its a patch but not sure how the issue is originally coming from.
                    [FIXED]
                    Hitting play second time crashes. This is due to deleting physics when play is crashing. Fixed by correctly deleting physics.
                    [DONE]
                    Also the character is not back to T posing when play stops.
                    [FIXED] when moving the mouse in the top middle of the screen, the character turns back and is not facing mouse direction.
    [DONE]save and load blendspace
    [PENDING] Bug while getting material in model import UI. But Rendering looks fine.
    [PARTIALFIXED] Character UI. So we can update parameters, like which stateachine, playerController to use, etc.
        [DONE] Change statemachine on another imported character.
        [DONE] Delete statmachine instance when done so in CharacterUI.
        [DONE] Possess  the whole character not just the playerController. So even the camera.
    [DONE] Blendspace UI. Here we can  create a blendspace through editor UI.
    [PENDING] statemachine UI.
        [DONE] Basic usuable UI.
        [done] Add none as option to select in toState.
        [PENDING] saving logic: with new statemachine and existing statemachine.
            [FIXED] not working for new statemachine; saving errors.
        [DONE] if you save an existing state machine with different name. the old statemachine is deleted and a new one is created with new name.
            [PENDING] update the filesmap with new file.
            [PENDING] If a file is updated, All its occurences in memory will need to updated somehow. Otherwise the program needs to be restarted. Try something in serializable class itself.
        [FIXED] saving things from statemachine UI errors out with <eof> missing error in lua condition. Fixed using trim function.

[FOR LATER][PENDING]Some script that can populate engineAssets directory as the files are too large for github.

[PENDING] Saving project files
1. try saving a level.
2. then lets try saving a project -- which should be a collection of saving levels.
3. then a handy exe file, in that project, that can run the editor and open the starting level, create an empty level if none is found.
4. save the floorBox from createNewProject and try loading that project.
What things to save:
1. Character, model
1. skeleton
2. capsuleCollider -- inheritance going on. capsule collider - physicsObject
2. playerController
3. blendspace
3. Animation
4. statemachine
5. input
6. level

For BlendSpace 2D to fully correctly work
1. Time warp
2. Registration Curves

BLending is not perfect I am  anyways trying adding inputs:
1. issue: BlendFactor is not being considered. we just have input of the blendPoint.
Now every animation selected will be blended by the blendFactor which represents the closeness
of the blend point to the animations. Animatoins with lower blend factor will have more influence.
I see I m passing the blendPoint locatoin as the blendFactor ( which is wrong).

We are getting wrong blendfactor when we are at intermediate position in blendspace.

Tried fixing it with blendfactor for each of the selected animatoins to blend. Buts its not  perfect still.
1,1 should be walk but model disappears but walk works until 0.999..., 0.999...

[DONEHERE] Alright got the correct blending logic in place.

[DONE] Fix the poping when 1 animation completely takes over. Probably fixed using registration curves and other techiniques.
Didnot use registration curves corrected the blending logic and application of blendfactor specifically rotational solved this issue.

---Details---

1. [DONE] Active PlayerController. PlayerController class (Character uses the playerController to recieve cmds).  To know which character to apply actions (Like animation) when given the cmd.
---Details---
I have clientHandler. We can just keep it for global in engine handling of camera and client's Input.

create activePlayerController pointer. If its not set use the clientHandler.

PlayerController: will have just a InputHandler and will give control cmds to attached StateMachine on the character.
StateMachine can be a simple enum based one.

[Bug] [DONE] For now we need to select a model to load an animation because we parse the model's bones to read the animation data from the animation file. We can later make the boneData completely standalone in the animation file.
Since when applying the animation we just lookup the animation.
Actually I was easily able to separate them.

We need a Play state in the game. When play is hit we switch the 1st player controller or active player controller as being controlled.

---Details---

1. [DONE] pressing key to change animation. Maybe start with walk cycle using WASD.

11. [PENDING] Draw bone vertex influence; improve debugging this.
increment, decrement,  highlight the bone and show its name. Tried to implment this still the data is not clear. 

12. [PENDING] I could improve how the bones look (something like blender) and
Also have them controlled ( we control its local transform ).

13. [PENDING] Select vertex and read its data -> like which bone influences is and so  on.

14. [PENDING] make stopping the animation work.

8. [DONE] vertex position is updated on GPU but not CPU so model selection is broken ( since it happens on CPU)

9. [DONE] Animator.hpp -> CalculateBoneTransform is the best place to draw bone

10. [DONE] First get the bones to render even when character is T-posing/Default-pose ( No animatoin is loaded).
Sort of worked. Still missing some bones.
Now animation is broken. Lets first fix the animation first.

Done more detail below
--- Detail ----

eye is not animated because no bone is influencing it.
---
Bone influence is local to model, they are used to animate the vertices they influence.
After fixing issue 10. This is working.
---

[PROBLEM] Lets assume boneInfoMap is correct when we have attached an animation
So now why would bones get wrong transformation ?
If an animation is attached, check if the bone exists in the animation, get its transform.
If the bone does not exists use the node's default transformation gotten from Skeleton.
But I think the array index to which we apply the a transformation is wrong.

LeftShoulder bones were for example were not rendered.
It is because in bind pose bones that only influence rotation will inherit their parent's location.
So these bones and thier parent's position were same.

But during animation these bones recieve location as well so get drawn. Animation also stores location data of these bones.

its still not accurate. What we are missing:
1. How to tell if a parent-child relation is using keepOffset or not: Compare the parent-child direction vector with orientation of the parent bone. And if its pointing towards child the relationship is not using keep offset.
2. Lets store the sphere models rendering logic in  main.cpp so we can active correct shader.
3. Loading static meshes is broken fix that first

4. [PROGRESS>>>] I actually found what is causing animation to render wrong. The Node graph of bones has nodes that are not bones and that is why the animation explodes.

5. I found this document: https://github.com/assimp/assimp/issues/4035. There are extra helper node in the aiScene followed by the actual node.
These need to be combined in the order they occur to get the local transformation of the bone.

6. Now its working....

--- Detail ----


## create a new blendspace and use it in a statemachine:
Test the statemachine on a character.
[DONE] Import an animation.
[DONE] Edit a blendspace. be able to move the points.
[DONE] When hover on blend point, show the animation name.
[DONE] Let user dial position of a selected blendpoint.
[DONE] Able to edit a blendspace which was already attached to a statemachine.
[DONE] create new blendspace and statemachine. Then attach the statemachine to a character.
    [Bug] When saving freshly created statemachine the UI resets to empty.
[PENDING] Add ability to sprint. We still will not save a playerController or inputmapping. For now hardcode a boolean playerController.isSprinting and input mapping (shift key) which dictates if the player is sprinting.

## Populate a level
[PENDING] Right now we can only have flat floor. Make a decent level.
    [DONE] Load model and character: import a model opens UI you can select either to import a model or character.
    [DONE] texture names pointing to Engine installed location and not project location.
    [PENDING] Right now we import model and create an instance of it in the active level. Saving models that were imported. It works has bugs.
        [DONE] saved model but it disappeared.
        [DONE] renderable location is saved in renderable file causing new instances to spawn at old saved location of that file.
            1. don't serialize model matrix.
                a. one model load -- init identityMatrix.
                b. progress: Added mat4 parameter to parent serializable class ( not all child classes need that though since not all being renderables; maybe better solution is to call another function separately ). The transformations are getting applied wrong on character maybe due to capsule collider getting inf transform
                    b.1. new instances of model got created at world origin.
                    b.2. still no way to select them though. Need to fix it.
    [DONE] Saving characters that were imported.
    [DONE] Save all the characters and models refs with transformation that were loaded into level.
[DONE] Don't save duplicate models. Ability to add multiple instances of a model/Character.
    [DONE] Loading cube loaded and empty.
[DONE] transformation should not be saved in character/Model file. Save it only in level.
 
## THIRD PERSON CAMERA:
1. [DONE] (AIMING): Always face camera direction on input when aiming.
2. [DONE] (NOT AIMING): Use camera direction to process directional input.
    a. Get direction of input based on camera's viewpoint
    b. Rotate the character in the direction of the input.
    c. And  play forward running/walking animation.
3. [PENDING] Fix dodging logic. Character dodges 0 distance when idling in third person.

## Lighting
[PENDING] Add a model to render light position/type.
[PENDING] Add different types of light sources.
    1. [DONE] Point light
        [DONE] Add UI to update intensity, color of light.
    2. [DONE] Direction light
        [DONE] Add UI to update intensity, color, direction of the light.
    3. [DONE] Spot Light
        [DONE] Add UI to update intensity, color, direciton, inner and outer radius.
[DONE] Fix some bug in Floor model and its collider going through z-fighting. donot render the collider on play and exlude it from having light interactions.
    1. Disabled rendering the collider but  the issue still persists. Its due to some clipping we have, so the light is not rendering ( noticed it when I moved away from other model they disappeared )
    [CONTINUE] changes so we can pass tangent and bitangents to character and static mesh shaders.
    [FIXED] the default normalmap when no normal texture is bound was wrong. So generated a correct one.
[PENDING] Add uniforms for number of lights of each type. So we have one source of truth.

### Culling Lights
[DONE] Shadow maps for directional lights (cascaded shadow maps for sun).
    a. Create shadowMap
    b. use shadowMap
    c. shadow map resolution will be issue for large scene. Solved through cascaded shadow map.
[DONE] Shadow maps / shadow cubes for point lights (depth cubemap).
[DONE] spot light shadow maps (single depth texture).
    [PENDING] Add cone to spot light.
[PENDING] Emmsive surfaces and shadows.

## AI
1. Very Simple NPC:
    Spawn a character -> attach a playerController -> Provide random movement input for it to move.
2. Complex:
    [PENDING] Decision Tree.
    [PENDING] path finding.
        a. (in a graph) - dijstra's algo or its optimized version A* Algorithm.
        b. (in a 3d environment ) - nav mesh. triangles connected to form mesh. each triangle is a node in the graph and edges of triangles are edges of the graph.
        c. Smoothing of path finding result from A* algorithm using Funnel Algorithm.

### NAV Mesh Generation using Recast DeTour cpp library:
https://github.com/recastnavigation/recastnavigation
1. [DONE] use the data generated to initialized nav mesh and render it.
2. [DONE] implment path finding on this.
3. [DONE] NavMeshBuild.build function fails. Go through the DemoCode in recast library and Add tests in our project to make it functioning.
        Fix - the issue was in how I was providing the world vertices and indices by joining all the meshes.
    [DONE] Render NavMesh that got generated.
    [DONE] Using the navmesh.

### AI class Improvements:
[PENDING] Saving the AI to disk.
    a. Add AI instance record to lvl save file.
    b. Add renderable instance record to lvl save file.
    c. Create GetInstance function on Renderable and AI class.
    d. When a Asset is placed on a Level give it a instanceId. This is different from guid that we use to identify files no disk.
        d.1. guid/asset_id is like id of the class. And instance_id is id of the instance. We need instance id so we can connect which AI is connected to which instance of renderable that is loaded in the level.
1.1. Loading AI -> loads the appropiate character instance and attaches it to currently active level.

1.2 [DONE] TESTING
    a. Create new Project.
    b. Check if AI files got created.(Both .meta and .AI files).
    c. open the project. And you should see AI character spawning.
1.3 UI for creating AI. Right click no AssetBrowser to create AI file and edit it.

2. [PENDING] By default no camera attached on AI controller character. Add config on character if camera needs to assigned.
3. [PENDING] Movement logic coming from LUA. Right now we are polluting playerController and character core codebases.
   4. LUA editor. Let user write some tick function. Most likely need to move this logic which is right now in PlayerController to LUA files.
4. [DONE] Level to call tick function of AI instances. Add vector<AI> in Level class. And saving.

## [TOO HARD] VS code as external LUA EDITOR
1. Add Extension: Lua Language Server.
2. Reloading Lua scripts (at frame boundary not during lua calls): press CTRL + R to reload all Lua scripts that are part of project i.e. in Assets/**/.lua.
3. make IntelliSense know your engine API.
    a. Add a .luarc.json at your project root. This tells LuaLS what Lua runtime you use and where to look for your engine API definitions
    b. Provide your engine API to LuaLS using stub files (this is the “main thing”). Generate stubs from your bindings that you pass from C++ → Lua (sol2). Then Auto-generate EngineAPI/*.lua from it So IntelliSense always matches your engine.

## Scripting using CPP.
This will help me understand basics of what it takes to get per project script to run the game.
Then later we can take the learnings too LUA.
This way can lead us closer to compiling the game's executable as well.
1. Compile cpp files in a project as separate DLL.


## Structural change needed to support scripting:
### The game engine folder
1. engine runtime library.
2. projectmanager.exe.
### The project folder
1. The projectmanager.exe shipped with game is what creates these cmake project and add engine lib to them.
2. Project can be compiled in editor UI mode or game executable mode. Basically two views for the project.


### Tasks
1. Update projectmanager logic.
    a. create projectmanager.exe and editor.exe. Current state: disabled spawning editor UI from  project manager code. Not sure how to invoke editor.exe for the project yet.
    b. Logic update: create cmake project (very vague but for now just create the project folder and add cmakelist.txt ) and add engine lib to project.
    c. Need to update the cmake_template for projects. Still getting some shader errors in Project debug run.
    d. IDEs not able to function with engine build package. For now using VS code as atleast I can get stack trace for debugging.
    e. Create callbacks in engine to attach codeblocks from project.
3. UI to load model file and skeleton file. Then we can create character entity obj from loaded model and skeletal file.
    a. [DONE] fix mesh data getting loaded wrong.
    b. [DONE] model after importing does not appear in loaded level. fix it by not loading the model into level just keep it in asset browser. Then we can click and add it active level.
    c. [DONE] Level saving broken. Since we copy level directory from cmake directory to build directory. And on Runtime things are being saved in build directory which will be overridden.
        i. Update CMAKE_ROOT directory path to correctly be consumed by projects.
    d. Ability to Create character entity object (I will call it prefab) file on disk for a project. (Basically its a UI to create character)
        i. create three virtual methods in characterBase class to override. OnStart(), Tick(), OnDestroy().
        ii. Ability to add this character entity object file to a level. Expose some callback from level via editor controls.
        iii. [IN PROGRESS] Ready to read and write prefab file of character. Next Finish up Character UI to display this prefab json file. So we can save and read prefabs.
        iv. CharacterUI is hooked up. Now Call these functions. Filepath usage and how to provide is little unclear. Test creating new prefab and opening then editing existing prefab.
        v.  GenericFactory registration using MACRO not working yet... . SOLVED made the macro more generic.
        vi. Make the scriptable class work. Add onStart(), OnTick(), OnDestroy() methods. Trying to do in character class: go through the code see what can be removed.
        vii. separate springArm logic from camera class. The editor still won't work. We need a eventBased way to make camera work. Create a editorFlyCam class and move the default camera movement logic here.
        viii. [PENDING]Able to create character usign prefab file. On Player There is this error `uniform inactive/not found for finalBonesMatrices[88]` for all boneIndexes. Character T-Posing for now.
                Animations are not loaded. Correct shaders loaded. Character is still not moving. Two things: 1. PlayerController 2. Statemachine.
                The statemachine is atleast starting now. It plays the ideal animation. Next look into inputs not working i.e. into PlayerController. Also Physics are not working.
4. PlayerController derived class for enabling scripting.
    i. Update CharacterUI to also let you Select a PlayerController class from project.
   ii. Create PlayerController Factory in GenericFactory so Engine can return an object of the derived class.
    iii. Add virtual GetClassId function in PlayerController which can overridden in the derived player controller.
    iv. assigning correct PlayerController class while loading character Prefab in Level file.
    v. Update read and read write logic of characterPrefab to/from disk.
   vi. when loading derived class object add the derived playerController object to playerControllers list so we can select active playerController.
    vii. [PENDING] Add onStart() onTick() onDestroy() callbacks. Then remove the movement logic from base to derived class.
        [DONE]Physics working. Character can now respond to user input. Statemachine works.
5. [DONE]Update Character Base logic. Make if isPlay or not always joltCharacter is the one that is moved. Then copy Transformation to 3D model + offset.
   Right now, in Capsule Collider class we create and delete the characterVirtual class based on is IsPlay is enabled. I have moved this to constructor so we always have characterVirtual initilaized.
    game builds but the character is unable to move... will see why. Fixed it: its due to I was not syncing the capsule transform back to characterTransform.
6. Fix: characterUI when opening an existing file it loads with nothing.
7. Saving Level
8. Scripting treatment to AI class as well. Make it work again.
        
## Compiling game.exe from your project.

### EngineState vs Levelstate.
1. Engine state should be able to discover all the project files. This is what we call Engine Registry.
2. Level state files are subset of Engine state files.

## Saving Lights to level.
[]
## Character shader is only using pointLight and no lighting shadows right now. Just copy it ?

## Other improvements:
[PENDING] Go through Advanced OPENGL section from learnopengl.com

## UI Improvements:
Clean up would help.


## Attack system
[PENDING] we cannot attack while moving. when attack button is pressed the player stops and plays the attack animation.
The enemy's capsule collider will be used for hit detection. With a physics body attached to say player's hand doing the hit.


## Game state

## Terrain

## Multiplayer sessions
[PENDING] client-server model.

## Audio system